// CommandCentered - Complete Prisma Schema
// Generated: 2025-01-09
// Status: DRAFT - Review required before locking
// Total Tables: 47

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["commandcentered"]
}

// ============================================
// PHASE 1: FOUNDATION (2 tables)
// ============================================

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name      String  @db.VarChar(255)
  subdomain String  @unique @db.VarChar(100)
  domain    String? @db.VarChar(255)
  isActive  Boolean @default(true) @map("is_active")

  // Relations
  userProfiles                 UserProfile[]
  events                       Event[]
  shifts                       Shift[]
  operators                    Operator[]
  operatorBlackoutDates        OperatorBlackoutDate[]
  operatorRatings              OperatorRating[]
  operatorSkills               OperatorSkill[]
  operatorSkillHistory         OperatorSkillHistory[]
  operatorGear                 OperatorGear[]
  operatorGearRequests         OperatorGearRequest[]
  skillDefinitions             SkillDefinition[]
  drills                       Drill[]
  drillAttendees               DrillAttendee[]
  drillAgendaItems             DrillAgendaItem[]
  gear                         Gear[]
  gearMovementHistory          GearMovementHistory[]
  gearAssignments              GearAssignment[]
  vehicles                     Vehicle[]
  gearKits                     GearKit[]
  deliverables                 Deliverable[]
  deliverableAssets            DeliverableAsset[]
  editors                      Editor[]
  bounties                     Bounty[]
  clientNotes                  ClientNote[]
  deliverableRevisionHistory   DeliverableRevisionHistory[]
  alerts                       Alert[]
  alertPreferences             AlertPreference[]
  leads                        Lead[]
  leadNotes                    LeadNote[]
  proposalTemplates            ProposalTemplate[]
  proposals                    Proposal[]
  proposalLineItems            ProposalLineItem[]
  contracts                    Contract[]
  contractSignatures           ContractSignature[]
  invoices                     Invoice[]
  invoiceLineItems             InvoiceLineItem[]
  payments                     Payment[]
  paymentSchedules             PaymentSchedule[]
  clients                      Client[]
  clientQuestionnaires         ClientQuestionnaire[]
  emailTracking                EmailTracking[]
  crmOrganizations             CrmOrganization[]
  crmContacts                  CrmContact[]
  crmInteractions              CrmInteraction[]
  googleDriveFolders           GoogleDriveFolder[]
  systemSettings               SystemSettings?
  integrationLogs              IntegrationLog[]
  shiftAssignments             ShiftAssignment[]
  serviceTemplates             ServiceTemplate[] // Round 3
  operatorAvailability         OperatorAvailability[] // Round 3
  magicLinks                   MagicLink[] // Round 3
  shiftTemplates               ShiftTemplate[] // Round 6 - GAP-04
  leadProducts                 LeadProduct[] // Round 6 - GAP-10
  dashboardWidgetPreferences   DashboardWidgetPreference[] // Round 6 - GAP-09
  communicationTouchpoints     CommunicationTouchpoint[] // Round 6 - GAP-11
  gearDependencies             GearDependency[] // Round 6 - GAP-07
  eventTypeGearRecommendations EventTypeGearRecommendation[] // Round 6 - GAP-06
  automatedEmailConfigs        AutomatedEmailConfig[] // Round 6 - GAP-12
  savedLeadSearches            SavedLeadSearch[] // Phase 12 - Lead Finder
  leadSourceConfigs            LeadSourceConfig[] // Phase 12 - Lead Finder
  campaigns                    Campaign[] // Phase 13 - Email Campaigns
  campaignSteps                CampaignStep[] // Phase 13 - Email Campaigns
  campaignLeads                CampaignLead[] // Phase 13 - Email Campaigns
  files                        File[] // File Upload System
  voiceCommands                VoiceCommand[] // AI Voice Agent
  aiExecutions                 AIExecution[] // AI Voice Agent
  savedSearches                SavedSearch[] // Saved Lead Finder searches

  @@map("tenants")
  @@schema("commandcentered")
}

model UserProfile {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  authUserId String   @unique @map("auth_user_id") @db.Uuid
  email      String   @db.VarChar(255)
  name       String?  @db.VarChar(255)
  role       UserRole @default(OPERATOR)
  isActive   Boolean  @default(true) @map("is_active")

  // Relations
  alertPreferences           AlertPreference[]
  clientNotesCreated         ClientNote[]
  dashboardWidgetPreferences DashboardWidgetPreference[] // Round 6 - GAP-09
  savedLeadSearches          SavedLeadSearch[] // Phase 12 - Lead Finder
  savedSearches              SavedSearch[] // Generic Saved Searches
  filesUploaded              File[] // File Upload System
  voiceCommands              VoiceCommand[] // AI Voice Agent
  userPreferences            UserPreferences? // User Customization

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("user_profiles")
  @@schema("commandcentered")
}

enum UserRole {
  SUPER_ADMIN
  COMPETITION_DIRECTOR
  STUDIO_DIRECTOR
  OPERATOR
  VIEWER

  @@map("user_role")
  @@schema("commandcentered")
}

// ============================================
// PHASE 2: LOGISTICS - SUITE 2 (27 tables)
// ============================================

// Events & Shifts

model Event {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventName String    @map("event_name") @db.Text
  eventType EventType @map("event_type")

  // Venue details
  venueName           String   @map("venue_name") @db.Text
  venueAddress        String   @map("venue_address") @db.Text
  venueLat            Decimal? @map("venue_lat") @db.Decimal(10, 8)
  venueLng            Decimal? @map("venue_lng") @db.Decimal(11, 8)
  parkingInstructions String?  @map("parking_instructions") @db.Text

  // Client info (denormalized - kept for legacy compatibility)
  clientName  String? @map("client_name") @db.Text
  clientEmail String? @map("client_email") @db.Text
  clientPhone String? @map("client_phone") @db.Text

  // Client relation (REQUIRED - all events must have a client)
  clientId String @map("client_id") @db.Uuid
  client   Client @relation(fields: [clientId], references: [id], onDelete: Restrict)

  // Timing (full event span)
  loadInTime  DateTime @map("load_in_time")
  loadOutTime DateTime @map("load_out_time")

  // Financial
  revenueAmount       Decimal? @map("revenue_amount") @db.Decimal(10, 2)
  actualRevenue       Decimal? @map("actual_revenue") @db.Decimal(10, 2)
  cancellationPenalty Decimal? @map("cancellation_penalty") @db.Decimal(10, 2)
  cancellationReason  String?  @map("cancellation_reason") @db.Text

  // Hotel info (Phase 2.1 + Round 3 enhancements)
  hasHotel          Boolean   @default(false) @map("has_hotel")
  hotelName         String?   @map("hotel_name") @db.Text
  hotelAddress      String?   @map("hotel_address") @db.Text
  hotelLat          Decimal?  @map("hotel_lat") @db.Decimal(10, 8)
  hotelLng          Decimal?  @map("hotel_lng") @db.Decimal(11, 8)
  hotelCheckInDate  DateTime? @map("hotel_check_in_date")
  hotelCheckInTime  DateTime? @map("hotel_check_in_time") @db.Time // Round 3 - specific time
  hotelCheckOutDate DateTime? @map("hotel_check_out_date")
  hotelNotes        String?   @map("hotel_notes") @db.Text

  // Telegram integration
  telegramGroupId        String?   @map("telegram_group_id") @db.Text
  telegramInviteLink     String?   @map("telegram_invite_link") @db.Text
  telegramGroupCreatedAt DateTime? @map("telegram_group_created_at")

  // Phase 3 integration
  contractId          String? @map("contract_id") @db.Uuid
  createdFromContract Boolean @default(false) @map("created_from_contract")
  autoCreated         Boolean @default(false) @map("auto_created")

  // Google Drive
  googleDriveFolderId  String? @map("google_drive_folder_id") @db.VarChar(255)
  googleDriveFolderUrl String? @map("google_drive_folder_url") @db.VarChar(500)

  // Vimeo Livestream Integration (Round 3 - Nov 2025)
  vimeoEventId  String? @map("vimeo_event_id") @db.VarChar(255)
  streamKey     String? @map("stream_key") @db.VarChar(255)
  rtmpUrl       String? @map("rtmp_url") @db.VarChar(500)
  embedCode     String? @map("embed_code") @db.Text
  livestreamUrl String? @map("livestream_url") @db.VarChar(500)

  // Status
  status       EventStatus @default(CONFIRMED)
  isMultiDay   Boolean     @default(false) @map("is_multi_day")
  specialNotes String?     @map("special_notes") @db.Text

  // Relations
  shifts                   Shift[]
  gearAssignments          GearAssignment[]
  deliverables             Deliverable[]
  alerts                   Alert[]
  communicationTouchpoints CommunicationTouchpoint[] // Round 6 - GAP-11
  files                    File[] // File Upload System
  operatorRatings          OperatorRating[]

  @@index([tenantId])
  @@index([status])
  @@index([loadInTime])
  @@map("events")
  @@schema("commandcentered")
}

enum EventType {
  DANCE_COMPETITION @map("dance_competition")
  RECITAL           @map("recital")
  CONCERT           @map("concert")
  PLAY              @map("play")
  OTHER             @map("other")

  @@map("event_type")
  @@schema("commandcentered")
}

enum EventStatus {
  CONFIRMED             @map("confirmed")
  SCHEDULED             @map("scheduled")
  IN_PROGRESS           @map("in_progress")
  COMPLETED             @map("completed")
  ARCHIVED              @map("archived")
  CANCELLED             @map("cancelled")
  PENDING_QUESTIONNAIRE @map("pending_questionnaire")
  PLANNING              @map("planning")
  BOOKED                @map("booked") // GAP-01: Calendar status
  TENTATIVE             @map("tentative") // GAP-01: Calendar status
  PROPOSAL              @map("proposal") // GAP-01: Calendar status

  @@map("event_status")
  @@schema("commandcentered")
}

model Shift {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventId String @map("event_id") @db.Uuid
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  shiftName      String   @map("shift_name") @db.Text
  startTime      DateTime @map("start_time")
  endTime        DateTime @map("end_time")
  isOverlapShift Boolean  @default(false) @map("is_overlap_shift")
  rolesNeeded    Json?    @map("roles_needed") @db.JsonB
  notes          String?  @db.Text

  // Relations
  shiftAssignments     ShiftAssignment[]
  operatorGearRequests OperatorGearRequest[]
  gearAssignments      GearAssignment[] // GAP-05: Per-shift gear assignment

  @@index([tenantId])
  @@index([eventId])
  @@index([startTime])
  @@map("shifts")
  @@schema("commandcentered")
}

model ShiftAssignment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  shiftId String @map("shift_id") @db.Uuid
  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Restrict)

  role    OperatorRole
  payType PayType      @default(HOURLY) @map("pay_type")

  // Hourly pay fields
  hourlyRate     Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(5, 2)
  actualHours    Decimal? @map("actual_hours") @db.Decimal(5, 2)

  // Flat rate field
  flatRate Decimal? @map("flat_rate") @db.Decimal(10, 2)

  calculatedPay Decimal @map("calculated_pay") @db.Decimal(10, 2)

  // Transportation
  needsRide      Boolean   @default(false) @map("needs_ride")
  rideProviderId String?   @map("ride_provider_id") @db.Uuid
  rideProvider   Operator? @relation("RideProvider", fields: [rideProviderId], references: [id], onDelete: SetNull)

  // Travel times
  travelTimeToShiftMinutes           Int? @map("travel_time_to_shift_minutes")
  travelTimeFromPreviousShiftMinutes Int? @map("travel_time_from_previous_shift_minutes")

  // Hotel opt-in
  hotelNeeded  Boolean @default(false) @map("hotel_needed")
  hotelOptedIn Boolean @default(false) @map("hotel_opted_in")

  // Status tracking
  status                  ShiftAssignmentStatus @default(CONFIRMED)
  cancelledAt             DateTime?             @map("cancelled_at")
  cancellationReason      String?               @map("cancellation_reason") @db.Text
  replacementAssignmentId String?               @map("replacement_assignment_id") @db.Uuid

  // Conflict tracking
  conflictLevel          ConflictLevel @default(NONE) @map("conflict_level")
  conflictOverrideReason String?       @map("conflict_override_reason") @db.Text

  // Audit
  actualHoursUpdatedAt DateTime? @map("actual_hours_updated_at")
  actualHoursUpdatedBy String?   @map("actual_hours_updated_by") @db.Uuid
  actualHoursNotes     String?   @map("actual_hours_notes") @db.Text

  notes String? @db.Text

  @@index([tenantId])
  @@index([shiftId])
  @@index([operatorId])
  @@index([status])
  @@index([needsRide])
  @@map("shift_assignments")
  @@schema("commandcentered")
}

enum OperatorRole {
  VIDEOGRAPHER @map("videographer")
  PHOTOGRAPHER @map("photographer")
  DIRECTOR     @map("director")
  ASSISTANT    @map("assistant")
  OTHER        @map("other")

  @@map("operator_role")
  @@schema("commandcentered")
}

enum PayType {
  HOURLY @map("hourly")
  FLAT   @map("flat")

  @@map("pay_type")
  @@schema("commandcentered")
}

enum ShiftAssignmentStatus {
  ASSIGNED  @map("assigned")
  CONFIRMED @map("confirmed")
  COMPLETED @map("completed")
  CANCELLED @map("cancelled")

  @@map("shift_assignment_status")
  @@schema("commandcentered")
}

enum ConflictLevel {
  NONE       @map("none")
  CAUTION    @map("caution")
  IMPOSSIBLE @map("impossible")

  @@map("conflict_level")
  @@schema("commandcentered")
}

// Operators

model Operator {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name  String  @db.Text
  email String  @db.VarChar(255)
  phone String? @db.Text

  // Profile
  primaryRole  String? @map("primary_role") @db.Text
  bio          String? @db.Text
  portfolioUrl String? @map("portfolio_url") @db.Text

  // Rates
  hourlyRate      Decimal @map("hourly_rate") @db.Decimal(10, 2)
  acceptsFlatRate Boolean @default(true) @map("accepts_flat_rate")

  // Transportation
  hasVehicle         Boolean  @default(false) @map("has_vehicle")
  vehicleDescription String?  @map("vehicle_description") @db.Text
  homeAddress        String?  @map("home_address") @db.Text
  homeLat            Decimal? @map("home_lat") @db.Decimal(10, 8)
  homeLng            Decimal? @map("home_lng") @db.Decimal(11, 8)

  status OperatorStatus @default(ACTIVE)

  // Ratings
  averageRating Decimal? @default(0) @map("average_rating") @db.Decimal(3, 2) // 0.00 to 5.00
  totalRatings  Int      @default(0) @map("total_ratings")

  // Relations
  shiftAssignments ShiftAssignment[]
  ridesProvided    ShiftAssignment[]      @relation("RideProvider")
  blackoutDates    OperatorBlackoutDate[]
  skills           OperatorSkill[]
  skillHistory     OperatorSkillHistory[]
  gear             OperatorGear[]
  gearRequests     OperatorGearRequest[]
  drillsAttended   DrillAttendee[]
  availability     OperatorAvailability[] // Round 3
  ratings          OperatorRating[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([status])
  @@map("operators")
  @@schema("commandcentered")
}

enum OperatorStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")

  @@map("operator_status")
  @@schema("commandcentered")
}

model OperatorBlackoutDate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date
  reason    String?  @db.Text

  @@index([tenantId])
  @@index([operatorId])
  @@index([startDate, endDate])
  @@map("operator_blackout_dates")
  @@schema("commandcentered")
}

model OperatorRating {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  eventId String? @map("event_id") @db.Uuid
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)

  rating     Decimal @db.Decimal(3, 2) // 0.00 to 5.00
  feedback   String? @db.Text
  ratedBy    String? @map("rated_by") @db.Uuid // User who gave the rating
  ratingType String  @default("event_performance") @map("rating_type") @db.VarChar(50) // event_performance, professionalism, technical_skill

  @@index([tenantId])
  @@index([operatorId])
  @@index([eventId])
  @@index([ratedBy])
  @@map("operator_ratings")
  @@schema("commandcentered")
}

model OperatorSkill {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  skillDefinitionId String          @map("skill_definition_id") @db.Uuid
  skillDefinition   SkillDefinition @relation(fields: [skillDefinitionId], references: [id], onDelete: Cascade)

  skillLevel Int @default(5) @map("skill_level")

  @@unique([operatorId, skillDefinitionId])
  @@index([tenantId])
  @@index([operatorId])
  @@index([skillDefinitionId])
  @@map("operator_skills")
  @@schema("commandcentered")
}

model OperatorSkillHistory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  skillType SkillType @map("skill_type")
  oldValue  Int       @map("old_value")
  newValue  Int       @map("new_value")
  reason    String?   @db.Text
  drillId   String?   @map("drill_id") @db.Uuid
  drill     Drill?    @relation(fields: [drillId], references: [id], onDelete: SetNull)
  updatedBy String?   @map("updated_by") @db.Uuid

  @@index([tenantId])
  @@index([operatorId])
  @@map("operator_skill_history")
  @@schema("commandcentered")
}

enum SkillType {
  VIDEOGRAPHY     @map("videography")
  PHOTOGRAPHY     @map("photography")
  DIRECTING       @map("directing")
  PROFESSIONALISM @map("professionalism")

  @@map("skill_type")
  @@schema("commandcentered")
}

model OperatorGear {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  name     String       @db.Text
  category GearCategory
  type     String       @db.Text
  status   GearStatus   @default(AVAILABLE)
  notes    String?      @db.Text

  // Relations
  requests OperatorGearRequest[]

  @@index([tenantId])
  @@index([operatorId])
  @@index([category])
  @@index([status])
  @@map("operator_gear")
  @@schema("commandcentered")
}

model OperatorGearRequest {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  shiftId String @map("shift_id") @db.Uuid
  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  operatorGearId String       @map("operator_gear_id") @db.Uuid
  operatorGear   OperatorGear @relation(fields: [operatorGearId], references: [id], onDelete: Cascade)

  requestStatus RequestStatus @default(REQUESTED) @map("request_status")
  isBorrowing   Boolean       @default(false) @map("is_borrowing")
  notes         String?       @db.Text

  @@index([tenantId])
  @@index([shiftId])
  @@index([operatorId])
  @@index([requestStatus])
  @@map("operator_gear_requests")
  @@schema("commandcentered")
}

enum RequestStatus {
  REQUESTED @map("requested")
  CONFIRMED @map("confirmed")
  DECLINED  @map("declined")
  CANCELLED @map("cancelled")

  @@map("request_status")
  @@schema("commandcentered")
}

// Skills & Drills

model SkillDefinition {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  skillName   String  @map("skill_name") @db.Text
  displayName String  @map("display_name") @db.Text
  description String? @db.Text
  isActive    Boolean @default(true) @map("is_active")
  sortOrder   Int     @default(0) @map("sort_order")

  // Relations
  operatorSkills OperatorSkill[]

  @@unique([tenantId, skillName])
  @@index([tenantId])
  @@map("skill_definitions")
  @@schema("commandcentered")
}

model Drill {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  drillName     String   @map("drill_name") @db.Text
  drillType     String   @map("drill_type") @db.Text
  drillDate     DateTime @map("drill_date") @db.Date
  durationHours Decimal? @map("duration_hours") @db.Decimal(4, 2)
  skillIncrease Int      @default(1) @map("skill_increase")
  notes         String?  @db.Text

  // Relations
  attendees         DrillAttendee[]
  agendaItems       DrillAgendaItem[]
  skillHistoryItems OperatorSkillHistory[]

  @@index([tenantId])
  @@index([drillDate])
  @@map("drills")
  @@schema("commandcentered")
}

model DrillAttendee {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  drillId String @map("drill_id") @db.Uuid
  drill   Drill  @relation(fields: [drillId], references: [id], onDelete: Cascade)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  attended      Boolean @default(true)
  skillUpgraded Boolean @default(false) @map("skill_upgraded")

  @@unique([drillId, operatorId])
  @@index([tenantId])
  @@index([drillId])
  @@index([operatorId])
  @@map("drill_attendees")
  @@schema("commandcentered")
}

model DrillAgendaItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  drillId String @map("drill_id") @db.Uuid
  drill   Drill  @relation(fields: [drillId], references: [id], onDelete: Cascade)

  itemName    String  @map("item_name") @db.Text
  description String? @db.Text
  duration    Int? // in minutes
  sortOrder   Int     @default(0) @map("sort_order")

  @@index([tenantId])
  @@index([drillId])
  @@map("drill_agenda_items")
  @@schema("commandcentered")
}

// Gear & Vehicles

model Gear {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name          String       @db.Text
  category      GearCategory
  type          String       @db.Text
  serialNumber  String?      @map("serial_number") @db.Text
  purchaseDate  DateTime?    @map("purchase_date") @db.Date
  purchasePrice Decimal?     @map("purchase_price") @db.Decimal(10, 2)
  status        GearStatus   @default(AVAILABLE)
  notes         String?      @db.Text

  // Relations
  movementHistory              GearMovementHistory[]
  assignments                  GearAssignment[]
  gearDependencies             GearDependency[]              @relation("GearDependencies") // Round 6 - GAP-07
  dependentGear                GearDependency[]              @relation("DependentGear") // Round 6 - GAP-07 (reverse)
  eventTypeGearRecommendations EventTypeGearRecommendation[] // Round 6 - GAP-06

  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@map("gear")
  @@schema("commandcentered")
}

enum GearCategory {
  CAMERA      @map("camera")
  LENS        @map("lens")
  AUDIO       @map("audio")
  COMPUTER    @map("computer")
  RIGGING     @map("rigging")
  CABLE       @map("cable")
  LIGHTING    @map("lighting")
  ACCESSORIES @map("accessories") // GAP-08: Missing category (Q10)
  STABILIZERS @map("stabilizers") // GAP-08: Missing category (Q10)
  DRONES      @map("drones") // GAP-08: Missing category (Q10)
  MONITORS    @map("monitors") // GAP-08: Missing category (Q10)
  OTHER       @map("other")

  @@map("gear_category")
  @@schema("commandcentered")
}

enum GearStatus {
  AVAILABLE      @map("available")
  IN_USE         @map("in_use")
  NEEDS_REPAIR   @map("needs_repair")
  IN_REPAIR      @map("in_repair")
  RETIRED        @map("retired")
  UNAVAILABLE    @map("unavailable")
  OUT_OF_SERVICE @map("out_of_service")

  @@map("gear_status")
  @@schema("commandcentered")
}

model GearMovementHistory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  gearId String @map("gear_id") @db.Uuid
  gear   Gear   @relation(fields: [gearId], references: [id], onDelete: Cascade)

  fromLocation String  @map("from_location") @db.Text
  toLocation   String  @map("to_location") @db.Text
  movedBy      String? @map("moved_by") @db.Uuid
  reason       String? @db.Text
  notes        String? @db.Text

  @@index([tenantId])
  @@index([gearId])
  @@index([createdAt])
  @@map("gear_movement_history")
  @@schema("commandcentered")
}

model GearAssignment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventId String @map("event_id") @db.Uuid
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  gearId String @map("gear_id") @db.Uuid
  gear   Gear   @relation(fields: [gearId], references: [id], onDelete: Cascade)

  vehicleId String?  @map("vehicle_id") @db.Uuid
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  // GAP-02: Kit assignment logic (Q12: event default, shift override)
  kitId String?  @map("kit_id") @db.Uuid
  kit   GearKit? @relation(fields: [kitId], references: [id], onDelete: SetNull)

  // GAP-05: Per-shift gear assignment (Q12: shift override)
  shiftId String? @map("shift_id") @db.Uuid
  shift   Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  packStatus        PackStatus @default(NEEDS_PACKING) @map("pack_status")
  brokenDuringEvent Boolean    @default(false) @map("broken_during_event")
  needsRetrieval    Boolean    @default(false) @map("needs_retrieval")
  retrievedAt       DateTime?  @map("retrieved_at")
  notes             String?    @db.Text

  @@unique([eventId, gearId])
  @@index([tenantId])
  @@index([eventId])
  @@index([gearId])
  @@index([kitId]) // GAP-02
  @@index([shiftId]) // GAP-05
  @@map("gear_assignments")
  @@schema("commandcentered")
}

enum PackStatus {
  NEEDS_PACKING @map("needs_packing")
  PACKED        @map("packed")
  AT_EVENT      @map("at_event")
  RETURNED      @map("returned")

  @@map("pack_status")
  @@schema("commandcentered")
}

model Vehicle {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name               String        @db.Text
  vehicleType        String        @map("vehicle_type") @db.Text
  licensePlate       String?       @map("license_plate") @db.Text
  status             VehicleStatus @default(AVAILABLE)
  outOfServiceAt     DateTime?     @map("out_of_service_at")
  outOfServiceReason String?       @map("out_of_service_reason") @db.Text
  notes              String?       @db.Text

  // Relations
  gearAssignments GearAssignment[]

  @@index([tenantId])
  @@index([status])
  @@map("vehicles")
  @@schema("commandcentered")
}

enum VehicleStatus {
  AVAILABLE      @map("available")
  IN_USE         @map("in_use")
  OUT_OF_SERVICE @map("out_of_service")
  IN_REPAIR      @map("in_repair")

  @@map("vehicle_status")
  @@schema("commandcentered")
}

model GearKit {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  kitName     String   @map("kit_name") @db.Text
  description String?  @db.Text
  gearIds     String[] @map("gear_ids") @db.Uuid
  isActive    Boolean  @default(true) @map("is_active")

  // Relations
  gearAssignments GearAssignment[] // GAP-02: Kit assignment tracking

  @@index([tenantId])
  @@map("gear_kits")
  @@schema("commandcentered")
}

// Post-Production (Phase 2.4)

model Deliverable {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  // Event is OPTIONAL (deliverables can be for client assets without events)
  eventId String? @map("event_id") @db.Uuid
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Client is REQUIRED (all deliverables must have a client, either direct or via event)
  clientId String @map("client_id") @db.Uuid
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  deliverableType      String            @map("deliverable_type") @db.Text
  deliverableName      String            @map("deliverable_name") @db.Text
  dueDate              DateTime          @map("due_date") @db.Date
  totalAssets          Int               @default(0) @map("total_assets")
  completedAssets      Int               @default(0) @map("completed_assets")
  assignedEditorId     String?           @map("assigned_editor_id") @db.Uuid
  assignedEditor       Editor?           @relation(fields: [assignedEditorId], references: [id], onDelete: SetNull)
  status               DeliverableStatus @default(NOT_STARTED)
  priority             Priority          @default(NORMAL)
  notes                String?           @db.Text
  completionPercentage Int               @default(0) @map("completion_percentage")

  // Google Drive
  googleDriveFolderId  String? @map("google_drive_folder_id") @db.VarChar(255)
  googleDriveFolderUrl String? @map("google_drive_folder_url") @db.VarChar(500)

  // Relations
  assets    DeliverableAsset[]
  bounties  Bounty[]
  revisions DeliverableRevisionHistory[]

  @@index([tenantId])
  @@index([eventId])
  @@index([clientId])
  @@index([assignedEditorId])
  @@index([dueDate])
  @@index([status])
  @@map("deliverables")
  @@schema("commandcentered")
}

enum DeliverableStatus {
  NOT_STARTED @map("not_started")
  IN_PROGRESS @map("in_progress")
  IN_REVIEW   @map("in_review")
  DELIVERED   @map("delivered")
  CANCELLED   @map("cancelled")

  @@map("deliverable_status")
  @@schema("commandcentered")
}

model DeliverableAsset {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  deliverableId String      @map("deliverable_id") @db.Uuid
  deliverable   Deliverable @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  assetName        String    @map("asset_name") @db.Text
  assetType        String?   @map("asset_type") @db.Text
  filePath         String?   @map("file_path") @db.Text
  fileSizeMb       Decimal?  @map("file_size_mb") @db.Decimal(10, 2)
  durationSeconds  Int?      @map("duration_seconds")
  completed        Boolean   @default(false)
  assignedEditorId String?   @map("assigned_editor_id") @db.Uuid
  assignedEditor   Editor?   @relation(fields: [assignedEditorId], references: [id], onDelete: SetNull)
  completedAt      DateTime? @map("completed_at")
  notes            String?   @db.Text

  // Relations
  bounties  Bounty[]
  revisions DeliverableRevisionHistory[]

  @@index([tenantId])
  @@index([deliverableId])
  @@index([assignedEditorId])
  @@index([completed])
  @@map("deliverable_assets")
  @@schema("commandcentered")
}

model Editor {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name                  String   @db.Text
  email                 String   @db.VarChar(255)
  phone                 String?  @db.Text
  specialties           String[] @db.Text
  hourlyRate            Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  flatRatePerProject    Decimal? @map("flat_rate_per_project") @db.Decimal(10, 2)
  maxConcurrentProjects Int      @default(3) @map("max_concurrent_projects")
  isActive              Boolean  @default(true) @map("is_active")
  notes                 String?  @db.Text

  // Relations
  deliverables      Deliverable[]
  assets            DeliverableAsset[]
  bountiesClaimed   Bounty[]
  revisionsAssigned DeliverableRevisionHistory[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([isActive])
  @@map("editors")
  @@schema("commandcentered")
}

model Bounty {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  deliverableId String?      @map("deliverable_id") @db.Uuid
  deliverable   Deliverable? @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  deliverableAssetId String?           @map("deliverable_asset_id") @db.Uuid
  deliverableAsset   DeliverableAsset? @relation(fields: [deliverableAssetId], references: [id], onDelete: Cascade)

  bountyType      String       @map("bounty_type") @db.Text
  bountyAmount    Decimal      @map("bounty_amount") @db.Decimal(10, 2)
  bountyCriteria  String       @map("bounty_criteria") @db.Text
  expiresAt       DateTime?    @map("expires_at")
  claimedBy       String?      @map("claimed_by") @db.Uuid
  claimedByEditor Editor?      @relation(fields: [claimedBy], references: [id], onDelete: SetNull)
  claimedAt       DateTime?    @map("claimed_at")
  bountyStatus    BountyStatus @default(OPEN) @map("bounty_status")
  completedAt     DateTime?    @map("completed_at")
  paidAt          DateTime?    @map("paid_at")
  notes           String?      @db.Text

  @@index([tenantId])
  @@index([deliverableId])
  @@index([deliverableAssetId])
  @@index([bountyStatus])
  @@index([claimedBy])
  @@map("bounties")
  @@schema("commandcentered")
}

enum BountyStatus {
  OPEN      @map("open")
  CLAIMED   @map("claimed")
  COMPLETED @map("completed")
  PAID      @map("paid")
  EXPIRED   @map("expired")

  @@map("bounty_status")
  @@schema("commandcentered")
}

model ClientNote {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventId String? @map("event_id") @db.Uuid

  source           String       @default("manual") @db.Text
  subject          String?      @db.Text
  content          String       @db.Text
  emailFrom        String?      @map("email_from") @db.Text
  emailSubject     String?      @map("email_subject") @db.Text
  emailReceivedAt  DateTime?    @map("email_received_at")
  priority         Priority     @default(NORMAL)
  isActionRequired Boolean      @default(false) @map("is_action_required")
  actionStatus     ActionStatus @default(PENDING) @map("action_status")
  createdBy        String?      @map("created_by") @db.Uuid
  createdByUser    UserProfile? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([eventId])
  @@index([source])
  @@index([isActionRequired])
  @@index([createdAt(sort: Desc)])
  @@map("client_notes")
  @@schema("commandcentered")
}

enum Priority {
  LOW      @map("low")
  NORMAL   @map("normal")
  HIGH     @map("high")
  URGENT   @map("urgent")
  CRITICAL @map("critical")

  @@map("priority")
  @@schema("commandcentered")
}

enum ActionStatus {
  PENDING     @map("pending")
  IN_PROGRESS @map("in_progress")
  COMPLETED   @map("completed")
  IGNORED     @map("ignored")

  @@map("action_status")
  @@schema("commandcentered")
}

model DeliverableRevisionHistory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  deliverableId String?      @map("deliverable_id") @db.Uuid
  deliverable   Deliverable? @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  deliverableAssetId String?           @map("deliverable_asset_id") @db.Uuid
  deliverableAsset   DeliverableAsset? @relation(fields: [deliverableAssetId], references: [id], onDelete: Cascade)

  revisionType     String         @map("revision_type") @db.Text
  requestedBy      String?        @map("requested_by") @db.Text
  requestedAt      DateTime       @default(now()) @map("requested_at")
  revisionNotes    String         @map("revision_notes") @db.Text
  assignedEditorId String?        @map("assigned_editor_id") @db.Uuid
  assignedEditor   Editor?        @relation(fields: [assignedEditorId], references: [id], onDelete: SetNull)
  status           RevisionStatus @default(PENDING)
  completedAt      DateTime?      @map("completed_at")
  resolutionNotes  String?        @map("resolution_notes") @db.Text

  @@index([tenantId])
  @@index([deliverableId])
  @@index([deliverableAssetId])
  @@index([status])
  @@map("deliverable_revision_history")
  @@schema("commandcentered")
}

enum RevisionStatus {
  PENDING     @map("pending")
  IN_PROGRESS @map("in_progress")
  COMPLETED   @map("completed")
  REJECTED    @map("rejected")

  @@map("revision_status")
  @@schema("commandcentered")
}

// Alerts

model Alert {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventId String? @map("event_id") @db.Uuid
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  level          AlertLevel @map("level")
  type           String     @db.Text
  message        String     @db.Text
  acknowledgedAt DateTime?  @map("acknowledged_at")
  resolvedAt     DateTime?  @map("resolved_at")

  // Polymorphic relationship
  relatedEntityType String? @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   String? @map("related_entity_id") @db.Uuid

  @@index([tenantId, resolvedAt])
  @@index([eventId])
  @@index([level, createdAt])
  @@map("alerts")
  @@schema("commandcentered")
}

enum AlertLevel {
  CRITICAL @map("critical")
  HIGH     @map("high")
  WARNING  @map("warning")
  MEDIUM   @map("medium")
  INFO     @map("info")
  LOW      @map("low")

  @@map("alert_level")
  @@schema("commandcentered")
}

model AlertPreference {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  userId String      @map("user_id") @db.Uuid
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  alertType      String  @map("alert_type") @db.Text
  enabled        Boolean @default(true)
  deliveryMethod String  @default("in_app") @map("delivery_method") @db.Text

  @@unique([userId, alertType])
  @@index([tenantId])
  @@index([userId])
  @@map("alert_preferences")
  @@schema("commandcentered")
}

// ============================================
// PHASE 3: CLIENT MANAGEMENT - SUITE 1 (18 tables)
// ============================================

// Lead Management

model Lead {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  email        String  @db.VarChar(255)
  organization String? @db.VarChar(255)
  phone        String? @db.VarChar(50)
  contactName  String? @map("contact_name") @db.VarChar(255)

  source        String? @db.VarChar(100)
  sourceDetails String? @map("source_details") @db.Text

  status       LeadStatus @default(NEW)
  statusReason String?    @map("status_reason") @db.Text

  assignedTo String? @map("assigned_to") @db.Uuid

  lastContactedAt DateTime? @map("last_contacted_at")
  nextFollowUpAt  DateTime? @map("next_follow_up_at")

  // CRM Enhancements (Round 3 - Nov 2025)
  typeOfContact    String? @map("type_of_contact") @db.VarChar(50) // "Email", "Phone", "In-person"
  contactFrequency String? @map("contact_frequency") @db.VarChar(50) // "Weekly", "Biweekly", "Monthly"
  productService   String? @map("product_service") @db.VarChar(100) // "Dance Recital", "Concert", etc.

  // Product-Focused Pipeline (Round 7 - Nov 2025)
  temperature String? @db.Text // "Hot Lead", "Warm Lead", "Cold Lead"

  // Relations
  notes                    LeadNote[]
  proposals                Proposal[]
  contracts                Contract[]
  invoices                 Invoice[]
  clients                  Client[]
  leadProducts             LeadProduct[] // Round 6 - GAP-10
  communicationTouchpoints CommunicationTouchpoint[] // Round 6 - GAP-11
  campaignLeads            CampaignLead[] // Phase 13 - Email Campaigns
  files                    File[] // File Upload System

  @@index([tenantId])
  @@index([status])
  @@index([assignedTo])
  @@index([nextFollowUpAt])
  @@map("leads")
  @@schema("commandcentered")
}

enum LeadStatus {
  NEW                @map("new")
  CONTACTED          @map("contacted")
  QUALIFIED          @map("qualified")
  PROPOSAL_SENT      @map("proposal_sent")
  PROPOSAL_VIEWED    @map("proposal_viewed")
  ENGAGED            @map("engaged")
  PROPOSAL_SUBMITTED @map("proposal_submitted")
  CONTRACT_SENT      @map("contract_sent")
  CONVERTED          @map("converted")
  LOST               @map("lost")
  DISQUALIFIED       @map("disqualified")

  @@map("lead_status")
  @@schema("commandcentered")
}

model LeadNote {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  leadId String @map("lead_id") @db.Uuid
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  note      String  @db.Text
  createdBy String? @map("created_by") @db.Uuid

  @@index([tenantId])
  @@index([leadId])
  @@map("lead_notes")
  @@schema("commandcentered")
}

// Proposal System

model ProposalTemplate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name         String    @db.VarChar(255)
  slug         String    @db.VarChar(255)
  serviceType  String?   @map("service_type") @db.VarChar(100)
  description  String?   @db.Text
  configJson   Json      @default("{}") @map("config_json") @db.JsonB
  publishedAt  DateTime? @map("published_at")
  publishedUrl String?   @map("published_url") @db.VarChar(500)
  createdBy    String?   @map("created_by") @db.Uuid

  // Relations
  proposals Proposal[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, slug])
  @@index([tenantId, publishedAt])
  @@map("proposal_templates")
  @@schema("commandcentered")
}

model Proposal {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  leadId String? @map("lead_id") @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  templateId String           @map("template_id") @db.Uuid
  template   ProposalTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)

  selectionsJson Json @default("{}") @map("selections_json") @db.JsonB

  eventDate      DateTime? @map("event_date") @db.Date
  eventStartTime DateTime? @map("event_start_time") @db.Time
  eventVenue     String?   @map("event_venue") @db.VarChar(255)
  eventNotes     String?   @map("event_notes") @db.Text

  subtotalAmount Decimal @default(0) @map("subtotal_amount") @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal @default(0) @map("total_amount") @db.Decimal(10, 2)
  currency       String  @default("CAD") @db.VarChar(3)

  status      ProposalStatus @default(SUBMITTED)
  reviewedAt  DateTime?      @map("reviewed_at")
  reviewedBy  String?        @map("reviewed_by") @db.Uuid
  reviewNotes String?        @map("review_notes") @db.Text
  submittedAt DateTime       @default(now()) @map("submitted_at")

  // Relations
  lineItems ProposalLineItem[]
  contracts Contract[]

  @@index([tenantId])
  @@index([leadId])
  @@index([status])
  @@index([eventDate])
  @@index([reviewedBy])
  @@map("proposals")
  @@schema("commandcentered")
}

enum ProposalStatus {
  SUBMITTED @map("submitted")
  REVIEWING @map("reviewing")
  ACCEPTED  @map("accepted")
  REJECTED  @map("rejected")

  @@map("proposal_status")
  @@schema("commandcentered")
}

model ProposalLineItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  proposalId String   @map("proposal_id") @db.Uuid
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  serviceName        String  @map("service_name") @db.VarChar(255)
  serviceDescription String? @map("service_description") @db.Text
  quantity           Int     @default(1)
  unitPrice          Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice         Decimal @map("total_price") @db.Decimal(10, 2)
  category           String? @db.VarChar(100)
  Tenant             Tenant? @relation(fields: [tenantId], references: [id])
  tenantId           String? @db.Uuid

  @@index([proposalId])
  @@index([category])
  @@map("proposal_line_items")
  @@schema("commandcentered")
}

// Contracts

model Contract {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  proposalId String   @map("proposal_id") @db.Uuid
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Restrict)

  leadId String? @map("lead_id") @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  clientId String? @map("client_id") @db.Uuid
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  contractNumber     String  @map("contract_number") @db.VarChar(100)
  contractTemplateId String? @map("contract_template_id") @db.Uuid
  contractText       String  @map("contract_text") @db.Text
  contractPdfUrl     String? @map("contract_pdf_url") @db.VarChar(500)

  totalAmount   Decimal  @map("total_amount") @db.Decimal(10, 2)
  currency      String   @default("CAD") @db.VarChar(3)
  depositAmount Decimal? @map("deposit_amount") @db.Decimal(10, 2)
  paymentTerms  String?  @map("payment_terms") @db.Text

  status   ContractStatus @default(DRAFT)
  sentAt   DateTime?      @map("sent_at")
  signedAt DateTime?      @map("signed_at")

  eventId String? @map("event_id") @db.Uuid

  // Relations
  signatures       ContractSignature[]
  invoices         Invoice[]
  paymentSchedules PaymentSchedule[]
  questionnaires   ClientQuestionnaire[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId])
  @@index([proposalId])
  @@index([leadId])
  @@index([clientId])
  @@index([status])
  @@map("contracts")
  @@schema("commandcentered")
}

enum ContractStatus {
  DRAFT     @map("draft")
  SENT      @map("sent")
  SIGNED    @map("signed")
  CANCELLED @map("cancelled")

  @@map("contract_status")
  @@schema("commandcentered")
}

model ContractSignature {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contractId String   @map("contract_id") @db.Uuid
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  signerEmail        String    @map("signer_email") @db.VarChar(255)
  signerName         String?   @map("signer_name") @db.VarChar(255)
  signerRole         String?   @map("signer_role") @db.VarChar(100)
  signatureData      String?   @map("signature_data") @db.Text
  signatureIp        String?   @map("signature_ip") @db.VarChar(100)
  signatureTimestamp DateTime? @map("signature_timestamp")

  status         SignatureStatus @default(PENDING)
  requestSentAt  DateTime?       @map("request_sent_at")
  lastRemindedAt DateTime?       @map("last_reminded_at")
  reminderCount  Int             @default(0) @map("reminder_count")
  Tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  tenantId       String?         @db.Uuid

  @@index([contractId])
  @@index([status])
  @@index([signerEmail])
  @@map("contract_signatures")
  @@schema("commandcentered")
}

enum SignatureStatus {
  PENDING  @map("pending")
  SENT     @map("sent")
  VIEWED   @map("viewed")
  SIGNED   @map("signed")
  DECLINED @map("declined")

  @@map("signature_status")
  @@schema("commandcentered")
}

// Payments

model Invoice {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  contractId String?   @map("contract_id") @db.Uuid
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  leadId String? @map("lead_id") @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  invoiceNumber String   @map("invoice_number") @db.VarChar(100)
  invoiceDate   DateTime @default(now()) @map("invoice_date") @db.Date
  dueDate       DateTime @map("due_date") @db.Date

  subtotalAmount Decimal @map("subtotal_amount") @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount    Decimal @map("total_amount") @db.Decimal(10, 2)
  amountPaid     Decimal @default(0) @map("amount_paid") @db.Decimal(10, 2)
  currency       String  @default("CAD") @db.VarChar(3)

  status InvoiceStatus @default(DRAFT)
  sentAt DateTime?     @map("sent_at")
  paidAt DateTime?     @map("paid_at")

  stripeInvoiceId String? @map("stripe_invoice_id") @db.VarChar(255)
  paymentLinkUrl  String? @map("payment_link_url") @db.VarChar(500)

  notes String? @db.Text

  // Relations
  lineItems        InvoiceLineItem[]
  payments         Payment[]
  paymentSchedules PaymentSchedule[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([contractId])
  @@index([leadId])
  @@index([status])
  @@index([dueDate])
  @@index([stripeInvoiceId])
  @@map("invoices")
  @@schema("commandcentered")
}

enum InvoiceStatus {
  DRAFT     @map("draft")
  SENT      @map("sent")
  PAID      @map("paid")
  PARTIAL   @map("partial")
  OVERDUE   @map("overdue")
  CANCELLED @map("cancelled")

  @@map("invoice_status")
  @@schema("commandcentered")
}

model InvoiceLineItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  invoiceId String  @map("invoice_id") @db.Uuid
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String  @db.VarChar(500)
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal @map("total_price") @db.Decimal(10, 2)
  category    String? @db.VarChar(100)
  Tenant      Tenant? @relation(fields: [tenantId], references: [id])
  tenantId    String? @db.Uuid

  @@index([invoiceId])
  @@map("invoice_line_items")
  @@schema("commandcentered")
}

model Payment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  invoiceId String  @map("invoice_id") @db.Uuid
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("CAD") @db.VarChar(3)
  paymentDate   DateTime @default(now()) @map("payment_date")
  paymentMethod String?  @map("payment_method") @db.VarChar(50)

  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(255)
  stripePaymentMethodId String? @map("stripe_payment_method_id") @db.VarChar(255)

  status        PaymentStatus @default(PENDING)
  failureReason String?       @map("failure_reason") @db.Text

  refundAmount Decimal?  @default(0) @map("refund_amount") @db.Decimal(10, 2)
  refundedAt   DateTime? @map("refunded_at")
  refundReason String?   @map("refund_reason") @db.Text

  notes String? @db.Text

  @@index([tenantId])
  @@index([invoiceId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@map("payments")
  @@schema("commandcentered")
}

enum PaymentStatus {
  PENDING   @map("pending")
  SUCCEEDED @map("succeeded")
  FAILED    @map("failed")
  REFUNDED  @map("refunded")
  DISPUTED  @map("disputed")

  @@map("payment_status")
  @@schema("commandcentered")
}

model PaymentSchedule {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  contractId String   @map("contract_id") @db.Uuid
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  invoiceId String?  @map("invoice_id") @db.Uuid
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  milestoneName        String    @map("milestone_name") @db.VarChar(255)
  milestoneDescription String?   @map("milestone_description") @db.Text
  dueDate              DateTime? @map("due_date") @db.Date
  dueTrigger           String?   @map("due_trigger") @db.VarChar(100)

  amount     Decimal  @db.Decimal(10, 2)
  amountType String   @map("amount_type") @db.VarChar(50)
  percentage Decimal? @db.Decimal(5, 2)

  status ScheduleStatus @default(PENDING)
  paidAt DateTime?      @map("paid_at")

  @@index([tenantId])
  @@index([contractId])
  @@index([invoiceId])
  @@index([status])
  @@index([dueDate])
  @@map("payment_schedules")
  @@schema("commandcentered")
}

enum ScheduleStatus {
  PENDING @map("pending")
  DUE     @map("due")
  PAID    @map("paid")
  OVERDUE @map("overdue")
  WAIVED  @map("waived")

  @@map("schedule_status")
  @@schema("commandcentered")
}

// Clients

model Client {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  leadId String? @map("lead_id") @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  organization String  @db.VarChar(255)
  contactName  String? @map("contact_name") @db.VarChar(255)
  email        String  @db.VarChar(255)
  phone        String? @db.VarChar(50)
  website      String? @db.VarChar(500)

  addressLine1 String? @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String? @db.VarChar(100)
  province     String? @db.VarChar(100)
  postalCode   String? @map("postal_code") @db.VarChar(20)
  country      String? @default("Canada") @db.VarChar(100)

  industry String? @db.VarChar(100)
  size     String? @db.VarChar(50)

  status      ClientStatus @default(ACTIVE)
  statusNotes String?      @map("status_notes") @db.Text

  // Lifecycle tracking (spec: Initial Contact  Proposal  Contract  Invoice  Event  Delivery  Rebooking)
  lifecycleStage ClientLifecycleStage @default(INITIAL_CONTACT) @map("lifecycle_stage")
  lifecycleNotes String?              @map("lifecycle_notes") @db.Text

  // Email automation safety - prevents accidental emails to real clients during testing
  autoEmailsEnabled Boolean @default(false) @map("auto_emails_enabled")

  totalRevenue Decimal @default(0) @map("total_revenue") @db.Decimal(10, 2)
  totalEvents  Int     @default(0) @map("total_events")

  // Visual customization
  brandColor String? @map("brand_color") @db.VarChar(7) // Hex color code (e.g., #06b6d4)

  // Google Drive integration
  googleDriveFolderId  String? @map("google_drive_folder_id") @db.VarChar(255)
  googleDriveFolderUrl String? @map("google_drive_folder_url") @db.VarChar(500)

  // Notes
  notes String? @db.Text

  // Relations
  events                   Event[]
  contracts                Contract[]
  communicationTouchpoints CommunicationTouchpoint[] // Round 6 - GAP-11
  files                    File[] // File Upload System
  deliverables             Deliverable[]

  @@index([tenantId])
  @@index([leadId])
  @@index([status])
  @@index([lifecycleStage])
  @@map("clients")
  @@schema("commandcentered")
}

enum ClientStatus {
  ACTIVE      @map("active")
  INACTIVE    @map("inactive")
  BLACKLISTED @map("blacklisted")

  @@map("client_status")
  @@schema("commandcentered")
}

enum ClientLifecycleStage {
  INITIAL_CONTACT           @map("initial_contact")
  PROPOSAL_SENT             @map("proposal_sent")
  CONTRACT_SIGNED           @map("contract_signed")
  QUESTIONNAIRE_SENT        @map("questionnaire_sent")
  QUESTIONNAIRE_COMPLETED   @map("questionnaire_completed")
  INVOICE_SENT              @map("invoice_sent")
  DEPOSIT_PAID              @map("deposit_paid")
  FULL_PAYMENT_RECEIVED     @map("full_payment_received")
  EVENT_CONFIRMED           @map("event_confirmed")
  EVENT_COMPLETED           @map("event_completed")
  DELIVERED                 @map("delivered")
  REBOOKING                 @map("rebooking")

  @@map("client_lifecycle_stage")
  @@schema("commandcentered")
}

model ClientQuestionnaire {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  contractId String   @map("contract_id") @db.Uuid
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  questionnaireTemplateId String? @map("questionnaire_template_id") @db.Uuid
  questionsJson           Json    @map("questions_json") @db.JsonB
  responsesJson           Json?   @map("responses_json") @db.JsonB

  status         QuestionnaireStatus @default(PENDING)
  sentAt         DateTime?           @map("sent_at")
  completedAt    DateTime?           @map("completed_at")
  reminderSentAt DateTime?           @map("reminder_sent_at")
  reminderCount  Int                 @default(0) @map("reminder_count")

  @@index([tenantId])
  @@index([contractId])
  @@index([status])
  @@map("client_questionnaires")
  @@schema("commandcentered")
}

enum QuestionnaireStatus {
  PENDING   @map("pending")
  SENT      @map("sent")
  PARTIAL   @map("partial")
  COMPLETED @map("completed")

  @@map("questionnaire_status")
  @@schema("commandcentered")
}

// Email & CRM

model EmailTracking {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  relatedEntityType String? @map("related_entity_type") @db.VarChar(100)
  relatedEntityId   String? @map("related_entity_id") @db.Uuid

  emailProviderId String  @map("email_provider_id") @db.VarChar(255)
  toEmail         String  @map("to_email") @db.VarChar(255)
  fromEmail       String  @map("from_email") @db.VarChar(255)
  subject         String  @db.VarChar(500)
  bodyText        String? @map("body_text") @db.Text
  bodyHtml        String? @map("body_html") @db.Text

  templateName      String? @map("template_name") @db.VarChar(255)
  templateVariables Json?   @map("template_variables") @db.JsonB

  sentAt       DateTime  @default(now()) @map("sent_at")
  openedAt     DateTime? @map("opened_at")
  clickedAt    DateTime? @map("clicked_at")
  bouncedAt    DateTime? @map("bounced_at")
  bounceReason String?   @map("bounce_reason") @db.Text
  complainedAt DateTime? @map("complained_at")

  status EmailStatus @default(SENT)

  @@index([tenantId])
  @@index([relatedEntityType, relatedEntityId])
  @@index([toEmail])
  @@index([emailProviderId])
  @@index([sentAt])
  @@map("email_tracking")
  @@schema("commandcentered")
}

enum EmailStatus {
  SENT       @map("sent")
  DELIVERED  @map("delivered")
  OPENED     @map("opened")
  CLICKED    @map("clicked")
  BOUNCED    @map("bounced")
  COMPLAINED @map("complained")

  @@map("email_status")
  @@schema("commandcentered")
}

model CrmOrganization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name    String  @db.VarChar(255)
  website String? @db.VarChar(500)
  phone   String? @db.VarChar(50)
  email   String? @db.VarChar(255)

  city     String? @db.VarChar(100)
  province String? @db.VarChar(100)
  country  String? @default("Canada") @db.VarChar(100)

  organizationType String? @map("organization_type") @db.VarChar(100)
  size             String? @db.VarChar(50)

  studioPromoStatus String? @map("studio_promo_status") @db.VarChar(100)
  recitalStatus     String? @map("recital_status") @db.VarChar(100)
  studioSageStatus  String? @map("studio_sage_status") @db.VarChar(100)

  lastContactedAt  DateTime? @map("last_contacted_at") @db.Date
  nextFollowUpAt   DateTime? @map("next_follow_up_at") @db.Date
  contactFrequency String?   @map("contact_frequency") @db.VarChar(50)

  notes String? @db.Text

  // Relations
  contacts     CrmContact[]
  interactions CrmInteraction[]

  @@index([tenantId])
  @@index([organizationType])
  @@index([nextFollowUpAt])
  @@map("crm_organizations")
  @@schema("commandcentered")
}

model CrmContact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  organizationId String          @map("organization_id") @db.Uuid
  organization   CrmOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String  @db.VarChar(255)
  title       String? @db.VarChar(255)
  email       String? @db.VarChar(255)
  phone       String? @db.VarChar(50)
  linkedinUrl String? @map("linkedin_url") @db.VarChar(500)

  isPrimary Boolean @default(false) @map("is_primary")
  isActive  Boolean @default(true) @map("is_active")
  notes     String? @db.Text

  // Relations
  interactions CrmInteraction[]

  @@index([tenantId])
  @@index([organizationId])
  @@index([organizationId, isPrimary])
  @@map("crm_contacts")
  @@schema("commandcentered")
}

model CrmInteraction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  organizationId String          @map("organization_id") @db.Uuid
  organization   CrmOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contactId String?     @map("contact_id") @db.Uuid
  contact   CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  userId String? @map("user_id") @db.Uuid

  interactionType String  @map("interaction_type") @db.VarChar(50)
  subject         String? @db.VarChar(500)
  notes           String? @db.Text
  outcome         String? @db.VarChar(100)

  requiresFollowUp Boolean   @default(false) @map("requires_follow_up")
  followUpDate     DateTime? @map("follow_up_date") @db.Date
  followUpNotes    String?   @map("follow_up_notes") @db.Text

  interactionDate DateTime @default(now()) @map("interaction_date")

  @@index([tenantId])
  @@index([organizationId])
  @@index([contactId])
  @@index([userId])
  @@index([interactionDate])
  @@index([followUpDate])
  @@map("crm_interactions")
  @@schema("commandcentered")
}

// Integrations

model GoogleDriveFolder {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  relatedEntityType String @map("related_entity_type") @db.VarChar(100)
  relatedEntityId   String @map("related_entity_id") @db.Uuid

  folderId   String @map("folder_id") @db.VarChar(255)
  folderName String @map("folder_name") @db.VarChar(255)
  folderUrl  String @map("folder_url") @db.VarChar(500)

  sharedWithEmails String[] @map("shared_with_emails") @db.Text
  permissionLevel  String   @default("writer") @map("permission_level") @db.VarChar(50)

  status FolderStatus @default(ACTIVE)

  @@index([tenantId])
  @@index([relatedEntityType, relatedEntityId])
  @@index([folderId])
  @@map("google_drive_folders")
  @@schema("commandcentered")
}

enum FolderStatus {
  ACTIVE   @map("active")
  ARCHIVED @map("archived")
  DELETED  @map("deleted")

  @@map("folder_status")
  @@schema("commandcentered")
}

// ============================================
// ROUND 3 ADDITIONS (Nov 2025)
// Service Templates, Operator Availability, Magic Links
// ============================================

model ServiceTemplate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name                 String   @db.VarChar(255) // "1-Minute Highlight", "Dance Recital Standard"
  description          String?  @db.Text
  defaultDurationHours Int      @map("default_duration_hours") // 4, 8, 12
  defaultPrice         Decimal  @map("default_price") @db.Decimal(10, 2)
  defaultOperatorCount Int      @map("default_operator_count") // 1, 2, 3+
  deliverableTypes     String[] @map("deliverable_types") @db.Text // ["1 min video", "3x reels"]
  eventType            String?  @map("event_type") @db.VarChar(100) // "Dance Recital", "Concert"
  isActive             Boolean  @default(true) @map("is_active")

  @@index([tenantId])
  @@index([isActive])
  @@map("service_templates")
  @@schema("commandcentered")
}

model OperatorAvailability {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  operatorId String   @map("operator_id") @db.Uuid
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  date          DateTime  @db.Date // Date of availability
  startTime     DateTime? @map("start_time") @db.Time // For partial-day availability (e.g., "2:00 PM")
  endTime       DateTime? @map("end_time") @db.Time // For partial-day availability (e.g., "6:00 PM")
  availableType String    @default("full_day") @map("available_type") @db.VarChar(20) // "full_day", "partial", "unavailable"
  notes         String?   @db.Text

  @@unique([tenantId, operatorId, date])
  @@index([tenantId])
  @@index([operatorId])
  @@index([date])
  @@map("operator_availability")
  @@schema("commandcentered")
}

model SavedSearch {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  userId String?      @map("user_id") @db.Uuid
  user   UserProfile? @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String   @db.VarChar(100)
  searchType  String   @default("lead_finder") @map("search_type") @db.VarChar(50) // "lead_finder", etc.
  filters     Json // Store search filters as JSON
  resultCount Int      @default(0) @map("result_count")
  lastUsedAt  DateTime @default(now()) @map("last_used_at")

  @@index([tenantId])
  @@index([userId])
  @@map("saved_searches")
  @@schema("commandcentered")
}

model MagicLink {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at") // Default 7 days

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  token      String @unique @db.VarChar(255) // UUID token for URL
  entityType String @map("entity_type") @db.VarChar(50) // "proposal", "contract", "invoice", "questionnaire"
  entityId   String @map("entity_id") @db.Uuid
  clientId   String @map("client_id") @db.Uuid

  isUsed   Boolean   @default(false) @map("is_used")
  usedAt   DateTime? @map("used_at")
  maxUses  Int       @default(1) @map("max_uses") // How many times link can be used
  useCount Int       @default(0) @map("use_count") // How many times it's been used

  @@index([tenantId])
  @@index([token])
  @@index([clientId])
  @@index([expiresAt])
  @@map("magic_links")
  @@schema("commandcentered")
}

model SystemSettings {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @unique @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  stripePublishableKey String? @map("stripe_publishable_key") @db.VarChar(500)
  stripeSecretKey      String? @map("stripe_secret_key") @db.VarChar(500)
  stripeWebhookSecret  String? @map("stripe_webhook_secret") @db.VarChar(500)

  emailProvider    String? @map("email_provider") @db.VarChar(50)
  emailApiKey      String? @map("email_api_key") @db.VarChar(500)
  emailFromAddress String? @map("email_from_address") @db.VarChar(255)
  emailFromName    String? @map("email_from_name") @db.VarChar(255)

  googleDriveEnabled        Boolean @default(false) @map("google_drive_enabled")
  googleDriveParentFolderId String? @map("google_drive_parent_folder_id") @db.VarChar(255)
  googleDriveCredentials    Json?   @map("google_drive_credentials") @db.JsonB

  companyName    String? @map("company_name") @db.VarChar(255)
  companyLogoUrl String? @map("company_logo_url") @db.VarChar(500)
  primaryColor   String? @map("primary_color") @db.VarChar(7)
  secondaryColor String? @map("secondary_color") @db.VarChar(7)

  @@index([tenantId])
  @@map("system_settings")
  @@schema("commandcentered")
}

model IntegrationLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  integrationType String  @map("integration_type") @db.VarChar(50)
  eventType       String  @map("event_type") @db.VarChar(100)
  entityType      String? @map("entity_type") @db.VarChar(50)
  entityId        String? @map("entity_id") @db.Uuid

  status       IntegrationStatus @default(PENDING)
  errorMessage String?           @map("error_message") @db.Text
  metadata     Json?             @db.JsonB

  requestData  Json? @map("request_data") @db.JsonB
  responseData Json? @map("response_data") @db.JsonB

  processingTimeMs Int? @map("processing_time_ms")

  @@index([tenantId])
  @@index([integrationType])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([status])
  @@index([createdAt])
  @@map("integration_logs")
  @@schema("commandcentered")
}

enum IntegrationStatus {
  PENDING  @map("pending")
  SUCCESS  @map("success")
  FAILED   @map("failed")
  RETRYING @map("retrying")

  @@map("integration_status")
  @@schema("commandcentered")
}

// ============================================
// ROUND 6 ADDITIONS - Schema Gap Fixes
// Week 2: Nov 25 - Dec 1, 2025
// ============================================

// GAP-04 (P0 CRITICAL): ShiftTemplate table
// Blocks Q2, Q5: Shift builder templates (Recital, Corporate, Custom)
model ShiftTemplate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  templateName String     @map("template_name") @db.VarChar(100) // "Recital", "Corporate", "Custom"
  description  String?    @db.Text
  eventType    EventType? @map("event_type")
  shiftsConfig Json       @map("shifts_config") @db.JsonB // Shift definitions: [{shiftName, startTime, endTime, rolesNeeded}]

  isActive Boolean @default(true) @map("is_active")

  @@index([tenantId])
  @@index([isActive])
  @@map("shift_templates")
  @@schema("commandcentered")
}

// GAP-10 (P0 CRITICAL): LeadProduct table
// Blocks Q6, Q7: 4-product tracking (Studio Sage, Dance Recital, Competition Software, Core Video)
model LeadProduct {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  leadId String @map("lead_id") @db.Uuid
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  productName      String        @map("product_name") @db.VarChar(100) // "Studio Sage", "Dance Recital Package", etc.
  isInterested     Boolean       @default(false) @map("is_interested")
  status           ProductStatus @default(NOT_INTERESTED)
  revenueAmount    Decimal?      @map("revenue_amount") @db.Decimal(10, 2)
  projectedRevenue Decimal?      @map("projected_revenue") @db.Decimal(10, 2) // Round 7 - Product Pipeline
  notes            String?       @db.Text

  @@unique([leadId, productName])
  @@index([tenantId])
  @@index([leadId])
  @@index([status])
  @@map("lead_products")
  @@schema("commandcentered")
}

enum ProductStatus {
  NOT_INTERESTED @map("not_interested")
  DISCUSSING     @map("discussing")
  PROPOSAL       @map("proposal")
  WON            @map("won")
  LOST           @map("lost")
  NOT_APPLICABLE @map("not_applicable") // Round 7 - Product Pipeline

  @@map("product_status")
  @@schema("commandcentered")
}

// GAP-09 (P0 CRITICAL): DashboardWidgetPreference table
// Blocks Q15: Dashboard customization with checkbox modal
model DashboardWidgetPreference {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  userId String      @map("user_id") @db.Uuid
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  widgetType String  @map("widget_type") @db.VarChar(50) // "event_pipeline", "annual_revenue", "upcoming_events", etc.
  isVisible  Boolean @default(true) @map("is_visible")
  position   Json?   @db.JsonB // {x: number, y: number}
  size       Json?   @db.JsonB // {w: number, h: number}
  sortOrder  Int     @default(0) @map("sort_order")

  @@unique([userId, widgetType])
  @@index([tenantId])
  @@index([userId])
  @@map("dashboard_widget_preferences")
  @@schema("commandcentered")
}

// GAP-11 (P0 CRITICAL): CommunicationTouchpoint table
// Blocks Q13: 8 communication touchpoints (Initial Contact  Rebooking Outreach)
model CommunicationTouchpoint {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  leadId String? @map("lead_id") @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  clientId String? @map("client_id") @db.Uuid
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  eventId String? @map("event_id") @db.Uuid
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  touchpointType TouchpointType   @map("touchpoint_type")
  status         TouchpointStatus @default(PENDING)
  completedAt    DateTime?        @map("completed_at")
  notes          String?          @db.Text

  @@index([tenantId])
  @@index([leadId])
  @@index([clientId])
  @@index([eventId])
  @@index([touchpointType])
  @@map("communication_touchpoints")
  @@schema("commandcentered")
}

enum TouchpointType {
  INITIAL_CONTACT         @map("initial_contact")
  PROPOSAL_SENT           @map("proposal_sent")
  CONTRACT_SENT           @map("contract_sent")
  CONTRACT_SIGNED         @map("contract_signed")
  QUESTIONNAIRE_SENT      @map("questionnaire_sent")
  QUESTIONNAIRE_COMPLETED @map("questionnaire_completed")
  INVOICE_SENT            @map("invoice_sent")
  INVOICE_PAID            @map("invoice_paid")
  PRE_EVENT_REMINDER      @map("pre_event_reminder")
  POST_EVENT_FOLLOWUP     @map("post_event_followup")
  REBOOKING_OUTREACH      @map("rebooking_outreach")

  @@map("touchpoint_type")
  @@schema("commandcentered")
}

enum TouchpointStatus {
  PENDING   @map("pending")
  SCHEDULED @map("scheduled")
  COMPLETED @map("completed")
  SKIPPED   @map("skipped")

  @@map("touchpoint_status")
  @@schema("commandcentered")
}

// GAP-07 (P1 HIGH): GearDependency table
// Blocks Q8: "Suggest, don't assume" pattern for gear dependencies
model GearDependency {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  gearId String @map("gear_id") @db.Uuid
  gear   Gear   @relation("GearDependencies", fields: [gearId], references: [id], onDelete: Cascade)

  dependentGearId String @map("dependent_gear_id") @db.Uuid
  dependentGear   Gear   @relation("DependentGear", fields: [dependentGearId], references: [id], onDelete: Cascade)

  suggestionText String @map("suggestion_text") @db.Text // "Consider adding a tripod for this camera"
  priority       Int    @default(0) // 0 = low, 1 = medium, 2 = high

  @@unique([gearId, dependentGearId])
  @@index([tenantId])
  @@index([gearId])
  @@index([dependentGearId])
  @@map("gear_dependencies")
  @@schema("commandcentered")
}

// GAP-06 (P1 HIGH): EventTypeGearRecommendation table
// Blocks Q9: Event-type suggestions in kit creation
model EventTypeGearRecommendation {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  eventType EventType @map("event_type")

  gearId String @map("gear_id") @db.Uuid
  gear   Gear   @relation(fields: [gearId], references: [id], onDelete: Cascade)

  priority       Int     @default(0) // 0 = low, 1 = medium, 2 = high
  suggestionText String? @map("suggestion_text") @db.Text

  @@unique([eventType, gearId])
  @@index([tenantId])
  @@index([eventType])
  @@index([gearId])
  @@map("event_type_gear_recommendations")
  @@schema("commandcentered")
}

// GAP-12 (P1 HIGH): AutomatedEmailConfig table
// Blocks Q14: 7 automated email types configuration
model AutomatedEmailConfig {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  emailType    AutomatedEmailType @map("email_type")
  subject      String             @db.VarChar(255)
  bodyTemplate String             @db.Text // HTML template with placeholders: {{eventName}}, {{clientName}}, etc.
  isActive     Boolean            @default(true) @map("is_active")
  sendDelay    Int?               @map("send_delay") // Minutes before/after trigger event

  @@unique([tenantId, emailType])
  @@index([tenantId])
  @@index([isActive])
  @@map("automated_email_configs")
  @@schema("commandcentered")
}

enum AutomatedEmailType {
  SHOW_PROGRAM_REMINDER  @map("show_program_reminder")
  REBOOKING_FOLLOWUP     @map("rebooking_followup")
  CONTRACT_REMINDER      @map("contract_reminder")
  QUESTIONNAIRE_REMINDER @map("questionnaire_reminder")
  PAYMENT_REMINDER       @map("payment_reminder")
  DELIVERY_NOTIFICATION  @map("delivery_notification")
  THANK_YOU_FEEDBACK     @map("thank_you_feedback")

  @@map("automated_email_type")
  @@schema("commandcentered")
}

// ============================================
// PHASE 12: LEAD FINDER (2 tables)
// BUILD_PROTOCOL - Apollo.io Integration
// ============================================

// Saved Lead Searches - User's saved search criteria for Lead Finder
model SavedLeadSearch {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  userId String      @map("user_id") @db.Uuid
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  searchName     String    @map("search_name") @db.VarChar(100)
  searchCriteria Json      @map("search_criteria") @db.JsonB // {businessTypes, location, keywords, employees, revenue, etc.}
  resultCount    Int       @default(0) @map("result_count")
  lastRunAt      DateTime? @map("last_run_at")

  @@index([tenantId])
  @@index([userId])
  @@map("saved_lead_searches")
  @@schema("commandcentered")
}

// Lead Source Configuration - API credentials and settings for external lead sources
model LeadSourceConfig {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  sourceName        String    @map("source_name") @db.VarChar(50) // "Apollo.io", "ZoomInfo", "Hunter.io", etc.
  apiKey            String?   @db.VarChar(255) // Encrypted API key
  apiSecret         String?   @map("api_secret") @db.VarChar(255) // Encrypted secret if needed
  configJson        Json?     @map("config_json") @db.JsonB // Additional configuration
  isActive          Boolean   @default(false) @map("is_active")
  lastSyncAt        DateTime? @map("last_sync_at")
  totalLeadsFetched Int       @default(0) @map("total_leads_fetched")

  @@unique([tenantId, sourceName])
  @@index([tenantId])
  @@index([isActive])
  @@map("lead_source_configs")
  @@schema("commandcentered")
}

// ============================================
// PHASE 13: EMAIL CAMPAIGNS (3 tables)
// BUILD_PROTOCOL - Mailgun Integration
// ============================================

// Campaign - Email marketing campaigns
model Campaign {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  name         String         @db.VarChar(255)
  status       CampaignStatus @default(DRAFT)
  totalLeads   Int            @default(0) @map("total_leads")
  sentCount    Int            @default(0) @map("sent_count")
  openedCount  Int            @default(0) @map("opened_count")
  repliedCount Int            @default(0) @map("replied_count")
  revenue      Decimal        @default(0) @map("revenue") @db.Decimal(10, 2)
  lastSentAt   DateTime?      @map("last_sent_at")

  // Relations
  steps         CampaignStep[]
  campaignLeads CampaignLead[]

  @@index([tenantId])
  @@index([status])
  @@map("campaigns")
  @@schema("commandcentered")
}

enum CampaignStatus {
  DRAFT     @map("draft")
  ACTIVE    @map("active")
  PAUSED    @map("paused")
  COMPLETED @map("completed")

  @@map("campaign_status")
  @@schema("commandcentered")
}

// Campaign Step - Individual emails in a campaign sequence
model CampaignStep {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  campaignId String   @map("campaign_id") @db.Uuid
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  stepNumber   Int    @map("step_number") // 1, 2, 3, etc.
  stepName     String @map("step_name") @db.VarChar(100) // "Initial Outreach", "Follow-up"
  subject      String @db.VarChar(255)
  bodyTemplate String @map("body_template") @db.Text // HTML template with {{placeholders}}
  delayDays    Int    @default(0) @map("delay_days") // Days to wait after previous step
  sentCount    Int    @default(0) @map("sent_count")
  openedCount  Int    @default(0) @map("opened_count")
  repliedCount Int    @default(0) @map("replied_count")

  @@index([tenantId])
  @@index([campaignId])
  @@map("campaign_steps")
  @@schema("commandcentered")
}

// Campaign Lead - Join table linking campaigns to leads with tracking
model CampaignLead {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  campaignId String   @map("campaign_id") @db.Uuid
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  leadId String @map("lead_id") @db.Uuid
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  status           CampaignLeadStatus @default(PENDING)
  currentStep      Int                @default(1) @map("current_step")
  lastSentAt       DateTime?          @map("last_sent_at")
  lastOpenedAt     DateTime?          @map("last_opened_at")
  repliedAt        DateTime?          @map("replied_at")
  unsubscribedAt   DateTime?          @map("unsubscribed_at")
  opportunityValue Decimal?           @map("opportunity_value") @db.Decimal(10, 2)

  @@unique([campaignId, leadId])
  @@index([tenantId])
  @@index([campaignId])
  @@index([leadId])
  @@index([status])
  @@map("campaign_leads")
  @@schema("commandcentered")
}

enum CampaignLeadStatus {
  PENDING      @map("pending")
  SENT         @map("sent")
  OPENED       @map("opened")
  REPLIED      @map("replied")
  UNSUBSCRIBED @map("unsubscribed")

  @@map("campaign_lead_status")
  @@schema("commandcentered")
}

// File Upload System
model File {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  fileName    String  @map("file_name") @db.VarChar(255)
  fileType    String  @map("file_type") @db.VarChar(100) // MIME type
  fileSize    BigInt  @map("file_size") // Size in bytes
  filePath    String  @map("file_path") @db.Text // Supabase Storage path
  category    String  @default("documents") @db.VarChar(50) // documents, contracts, proposals, etc.
  description String? @db.Text

  // Optional relations
  eventId  String? @map("event_id") @db.Uuid
  event    Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)
  clientId String? @map("client_id") @db.Uuid
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  leadId   String? @map("lead_id") @db.Uuid
  lead     Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  uploadedById String       @map("uploaded_by_id") @db.Uuid
  uploadedBy   UserProfile? @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([category])
  @@index([eventId])
  @@index([clientId])
  @@index([leadId])
  @@index([uploadedById])
  @@map("files")
  @@schema("commandcentered")
}

// ============================================
// AI VOICE AGENT SYSTEM
// ============================================

model VoiceCommand {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String      @map("tenant_id") @db.Uuid
  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  userId   String      @map("user_id") @db.Uuid
  user     UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Voice Input
  audioUrl      String? @map("audio_url") @db.Text // Stored audio file URL
  transcription String  @db.Text // Whisper transcription

  // AI Processing
  parsedIntent Json    @map("parsed_intent") @db.JsonB // GPT-4 parsed intent
  action       String  @db.VarChar(50) // "query", "create", "update", "delete"
  entityType   String? @map("entity_type") @db.VarChar(50) // "event", "operator", "kit", etc.
  entityId     String? @map("entity_id") @db.Uuid

  // Execution
  status               CommandStatus @default(PENDING)
  requiresConfirmation Boolean       @default(false) @map("requires_confirmation")
  confirmedAt          DateTime?     @map("confirmed_at")
  executedAt           DateTime?     @map("executed_at")

  // Results
  success      Boolean @default(false)
  errorMessage String? @map("error_message") @db.Text
  result       Json?   @db.JsonB // Command execution result

  aiExecutions AIExecution[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("voice_commands")
  @@schema("commandcentered")
}

enum CommandStatus {
  PENDING               @map("pending")
  AWAITING_CONFIRMATION @map("awaiting_confirmation")
  CONFIRMED             @map("confirmed")
  EXECUTING             @map("executing")
  COMPLETED             @map("completed")
  FAILED                @map("failed")
  CANCELLED             @map("cancelled")

  @@map("command_status")
  @@schema("commandcentered")
}

model AIExecution {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  voiceCommandId String?       @map("voice_command_id") @db.Uuid
  voiceCommand   VoiceCommand? @relation(fields: [voiceCommandId], references: [id], onDelete: SetNull)

  // AI Model Info
  model         String @db.VarChar(50) // "gpt-4", "whisper-1"
  executionType String @map("execution_type") @db.VarChar(50) // "transcription", "parsing", "generation"

  // Input/Output
  inputTokens  Int?   @map("input_tokens")
  outputTokens Int?   @map("output_tokens")
  cost         Float? // Approximate cost in USD
  latencyMs    Int?   @map("latency_ms")

  // Request/Response
  request  Json @db.JsonB
  response Json @db.JsonB

  @@index([tenantId])
  @@index([voiceCommandId])
  @@index([model])
  @@index([createdAt])
  @@map("ai_executions")
  @@schema("commandcentered")
}

// ============================================
// USER PREFERENCES & CUSTOMIZATION
// ============================================

model UserPreferences {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String      @unique @map("user_id") @db.Uuid
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dashboard Customization
  dashboardLayout          Json?    @map("dashboard_layout") @db.JsonB // React Grid Layout config
  visibleWidgets           String[] @default([]) @map("visible_widgets") // Widget IDs that are visible
  dashboardDraggingEnabled Boolean  @default(false) @map("dashboard_dragging_enabled") // Enable drag & drop

  // Navigation Customization
  navigationCollapsed Boolean @default(false) @map("navigation_collapsed")
  navigationOrder     Json?   @map("navigation_order") @db.JsonB // Custom nav item order
  navigationLabels    Json?   @map("navigation_labels") @db.JsonB // Custom nav item labels

  // View Preferences
  defaultViewTypes Json? @map("default_view_types") @db.JsonB // Default view per page (card/table/calendar)
  panelSizes       Json? @map("panel_sizes") @db.JsonB // Resizable panel widths

  // Other Preferences
  theme                String  @default("dark") @db.VarChar(20) // "light", "dark", "tactical"
  notificationsEnabled Boolean @default(true) @map("notifications_enabled")

  @@index([userId])
  @@map("user_preferences")
  @@schema("commandcentered")
}
